<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>스터디 그룹 생성</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; padding: 20px; line-height: 1.6; background-color: #f8f9fa; }
    .container { max-width: 600px; margin: 0 auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h2 { text-align: center; margin-bottom: 30px; }
    form { display: grid; grid-template-columns: 120px 1fr; gap: 12px; align-items: center; }
    label { text-align: right; font-weight: bold; color: #495057; }
    input, select, textarea { padding: 10px; font-size: 14px; border: 1px solid #ced4da; border-radius: 4px; width: 100%; box-sizing: border-box; }
    .button-group { grid-column: 1 / -1; display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
    button { padding: 10px 25px; border: none; border-radius: 5px; color: white; cursor: pointer; font-size: 15px; transition: background-color 0.2s; }
    #create-btn { background-color: #007bff; }
    #create-btn:hover { background-color: #0056b3; }
    #back-btn { background-color: #6c757d; }
    #back-btn:hover { background-color: #5a6268; }
    #result { margin-top: 20px; padding: 15px; border: 1px solid transparent; border-radius: 5px; text-align: center; font-weight: bold; }
    .success { border-color: #28a745; background-color: #d4edda; color: #155724; }
    .error { border-color: #dc3545; background-color: #f8d7da; color: #721c24; }
  </style>
</head>
<body>

<div class="container">
  <h2>새 스터디 그룹 생성</h2>
  <form id="createStudyForm">
    <label for="title">스터디 제목:</label>
    <input type="text" id="title" value="실전 스프링부트 API 개발" required>

    <label for="maxMemberCount">최대 인원:</label>
    <input type="number" id="maxMemberCount" value="8" required>

    <label for="category">카테고리:</label>
    <select id="category" name="category">
      <option value="IT">IT</option>
      <option value="BUSINESS">경영</option>
      <option value="DESIGN">디자인</option>
      <option value="LANGUAGE">어학</option>
      <option value="EXAM">수험/자격증</option>
      <option value="ACADEMICS">학문</option>
      <option value="LIFESTYLE">라이프스타일</option>
      <option value="OTHER">기타</option>
    </select>

    <label for="province">시/도:</label>
    <input type="text" id="province" value="서울" required>

    <label for="district">시/군/구:</label>
    <input type="text" id="district" value="강남구" required>

    <label for="bio">짧은 소개:</label>
    <textarea id="bio" rows="2">JPA와 Spring Security 심화 학습</textarea>

    <label for="description">상세 소개:</label>
    <textarea id="description" rows="4">실무에서 마주할 수 있는 다양한 문제들을 해결하며 함께 성장할 스터디원을 모집합니다.</textarea>

    <div class="button-group">
      <button type="submit" id="create-btn">생성하기</button>
      <button type="button" id="back-btn">뒤로가기</button>
    </div>
  </form>

  <div id="result"></div>
</div>

<script>
  // ✨ 1. 페이지가 열리면 localStorage에서 Access Token을 가져옵니다.
  const accessToken = localStorage.getItem('accessToken');

  if (!accessToken) {
    alert('로그인 정보가 없습니다. 홈으로 이동하여 다시 로그인해주세요.');
    window.location.href = 'home.html'; // 토큰 없으면 홈으로 리다이렉트
  }

  document.getElementById('createStudyForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const form = event.target;
    const resultDiv = document.getElementById('result');

    if (!accessToken) {
      alert('❌ AccessToken이 없습니다. 다시 로그인해주세요.');
      window.location.href = 'home.html';
      return;
    }

    const data = {
      title: form.title.value,
      maxMemberCount: parseInt(form.maxMemberCount.value, 10),
      category: form.category.value,
      province: form.province.value,
      district: form.district.value,
      bio: form.bio.value,
      description: form.description.value
    };

    resultDiv.className = '';
    resultDiv.textContent = '생성 요청 중...';

    fetch('/api/studies', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        // ✅ Authorization 헤더에 Bearer + accessToken
        'Authorization': `Bearer ${accessToken}`
      },
      body: JSON.stringify(data)
    })
            .then(response => {
              if (response.status === 201) {
                const location = response.headers.get('Location');
                resultDiv.className = 'success';
                resultDiv.textContent = `✅ 성공! 스터디가 생성되었습니다. (위치: ${location})`;
              } else if (response.status === 401) {
                resultDiv.className = 'error';
                resultDiv.textContent = '❌ 인증 실패(401): 토큰이 만료되었거나 유효하지 않습니다. 다시 로그인해주세요.';
              } else {
                response.text().then(text => {
                  resultDiv.className = 'error';
                  resultDiv.textContent = `❌ 실패: ${response.status} - ${text || '알 수 없는 오류'}`;
                });
              }
            })
            .catch(error => {
              resultDiv.className = 'error';
              resultDiv.textContent = '❌ 네트워크 오류 또는 서버 연결 실패. CORS 설정을 확인하세요.';
              console.error('Fetch Error:', error);
            });
  });

  document.getElementById('back-btn').addEventListener('click', function() {
    window.location.href = "home.html";
  });
</script>

</body>
</html>
