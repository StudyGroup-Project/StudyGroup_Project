<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<title>í™ˆ</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			text-align: center;
			margin-top: 50px;
		}
		.token-box {
			border: 1px solid #ddd;
			background: #f9f9f9;
			margin: 20px auto;
			padding: 15px;
			width: 80%;
			max-width: 600px;
			border-radius: 8px;
			word-break: break-all;
			text-align: left;
		}
		button {
			padding: 10px 20px;
			border: none;
			border-radius: 5px;
			background: #d9534f;
			color: white;
			cursor: pointer;
			font-size: 14px;
			margin: 10px;
		}
	</style>
</head>
<body>

<h1>í™ˆ í™”ë©´</h1>
<p>ë¡œê·¸ì¸ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤ ğŸ‰</p>

<div class="token-box">
	<strong>Access Token:</strong>
	<p id="accessToken"></p>
	<strong>User ID (í† í°ì—ì„œ ì¶”ì¶œ):</strong>
	<p id="userId"></p>
</div>

<button id="create-study-btn">ìŠ¤í„°ë”” ìƒì„±í•˜ê¸°</button>
<button id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>

<script>
	const params = new URLSearchParams(window.location.search);
	let accessToken = params.get("accessToken") || localStorage.getItem("accessToken");
	let refreshToken = params.get("refreshToken") || localStorage.getItem("refreshToken");
	
	// âœ… í† í°ì„ localStorageì— ì €ì¥
	if (accessToken) localStorage.setItem("accessToken", accessToken);
	if (refreshToken) localStorage.setItem("refreshToken", refreshToken);
	
	// âœ… í”„ë¡œí•„ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
	async function checkProfile() {
		try {
			const res = await fetch("/api/users/me/profile", {
				headers: { "Authorization": "Bearer " + accessToken }
			});
			
			if (res.status === 404) {
				// í”„ë¡œí•„ ì—†ìŒ â†’ profile.htmlë¡œ ì´ë™
				window.location.href = "profile.html";
				return;
			}
			if (!res.ok) {
				alert("í”„ë¡œí•„ í™•ì¸ ì‹¤íŒ¨: " + res.status);
				return;
			}
			
			const payload = JSON.parse(atob(accessToken.split(".")[1]));
			document.getElementById("accessToken").textContent = accessToken;
			document.getElementById("userId").textContent = payload.sub;
		} catch (err) {
			alert("í”„ë¡œí•„ í™•ì¸ ì¤‘ ì˜¤ë¥˜: " + err);
		}
	}
	checkProfile();
	
	// âœ… ìŠ¤í„°ë”” ìƒì„± í˜ì´ì§€ ì´ë™
	document.getElementById("create-study-btn").addEventListener("click", function() {
		window.location.href = "createStudy.html";
	});
	
	// âœ… ë¡œê·¸ì•„ì›ƒ
	document.getElementById("logout-btn").addEventListener("click", async function() {
		try {
			localStorage.removeItem("accessToken");
			localStorage.removeItem("refreshToken");
			
			const res = await fetch("/api/auth/logout", {
				method: "POST",
				credentials: "include"
			});
			
			if (res.ok) {
				alert("ë¡œê·¸ì•„ì›ƒ ì„±ê³µ!");
				window.location.href = "login.html";
			} else {
				alert("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: " + res.status);
			}
		} catch (err) {
			alert("ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜: " + err);
		}
	});
</script>

</body>
</html>
